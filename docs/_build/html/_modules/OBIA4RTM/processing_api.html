
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <title>OBIA4RTM.processing_api &#8212; OBIA4RTM 1.0.0 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for OBIA4RTM.processing_api</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Thu Aug  1 08:46:00 2019</span>

<span class="sd">This module is part of OBIA4RTM.</span>

<span class="sd">It is the MAIN WRAPPER around the functionalities of the OBIA4RTM software.</span>
<span class="sd">NOTE that the software is at an experimental state and API changes might</span>
<span class="sd">apply frequently whenever bugs, inconsistencies or inefficient code is identified</span>

<span class="sd">Copyright (c) 2019 Lukas Graf</span>

<span class="sd">@author: Lukas Graf, graflukas@web.de</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">configparser</span> <span class="kn">import</span> <span class="n">ConfigParser</span><span class="p">,</span> <span class="n">MissingSectionHeaderError</span>
<span class="kn">import</span> <span class="nn">OBIA4RTM</span>
<span class="kn">from</span> <span class="nn">OBIA4RTM.S2_PreProcessor.s2_Py6S_attcor</span> <span class="kn">import</span> <span class="n">s2_Py6S_atcorr</span>
<span class="kn">from</span> <span class="nn">OBIA4RTM.S2_PreProcessor.s2_sen2core_attcor</span> <span class="kn">import</span> <span class="n">do_sen2core_preprocessing</span>
<span class="kn">from</span> <span class="nn">OBIA4RTM.S2_PreProcessor.s2_sen2core_attcor</span> <span class="kn">import</span> <span class="n">call_gdal_merge</span>
<span class="kn">from</span> <span class="nn">OBIA4RTM.mdata_proc.parse_s2xml</span> <span class="kn">import</span> <span class="n">parse_s2xml</span>
<span class="kn">from</span> <span class="nn">OBIA4RTM.mdata_proc.handle_gee_metadata</span> <span class="kn">import</span> <span class="n">parse_gee_metadata</span>
<span class="kn">from</span> <span class="nn">OBIA4RTM.mdata_proc.insert_scene_metadata</span> <span class="kn">import</span> <span class="n">insert_scene_metadata</span>
<span class="kn">from</span> <span class="nn">OBIA4RTM.zonal_stats.get_mean_refl_ee</span> <span class="kn">import</span> <span class="n">get_mean_refl_ee</span>
<span class="kn">from</span> <span class="nn">OBIA4RTM.zonal_stats.get_mean_refl</span> <span class="kn">import</span> <span class="n">get_mean_refl</span>
<span class="kn">from</span> <span class="nn">OBIA4RTM.inversion.inversion</span> <span class="kn">import</span> <span class="n">inversion</span>


<div class="viewcode-block" id="API"><a class="viewcode-back" href="../../index.html#OBIA4RTM.processing_api.API">[docs]</a><span class="k">class</span> <span class="nc">API</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    this is the main API wrapper class around the OBIA4RTM functionalities</span>

<span class="sd">    Usage</span>
<span class="sd">    -----</span>
<span class="sd">    &gt;&gt;&gt; from OBIA4RTM import processing_api         # import the API</span>
<span class="sd">    &gt;&gt;&gt; use_gee = True                              # Google Earth Engine will be used</span>
<span class="sd">    &gt;&gt;&gt; obia4rtm_api = processing_api.API(use_gee)  # construct an API class instance</span>
<span class="sd">    &gt;&gt;&gt; print(obia4rtm_api)                         # should be an object at some location</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    use_gee : Boolean</span>
<span class="sd">        determines if Google Earth Engine (True) or Sen2Core (False) was /</span>
<span class="sd">        should be used for preprocessing and data handling</span>
<span class="sd">    obia4rtm_home : String</span>
<span class="sd">        directory that contains the config files required for OBIA4RTM.</span>
<span class="sd">        If None the default OBIA4RTM home dir (in the user profile) is used</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_gee</span><span class="p">,</span> <span class="n">obia4rtm_home</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        class constructor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check if use_gee is Boolean</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">use_gee</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid value for use_gee parameter: &#39;</span>\
                             <span class="s1">&#39;Must be boolean!&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># set to class attribute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__use_gee</span> <span class="o">=</span> <span class="n">use_gee</span>
        <span class="c1"># determine the OBIA4RTM user directroy where all the config files</span>
        <span class="c1"># are stored</span>
        <span class="k">if</span> <span class="n">obia4rtm_home</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">obia4rtm_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">OBIA4RTM</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">obia4rtm_dir</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s1">&#39;OBIA4RTM_HOME&#39;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">obia4rtm_home</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="c1"># in any case, check if the directory is existing and can be accessed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">obia4rtm_home</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;Your OBIA4RTM user directory seems to &quot;</span>\
                  <span class="s2">&quot;be invalid!</span><span class="se">\n</span><span class="s2">Please check your OBIA4RTM installation or the &quot;</span>\
                  <span class="s2">&quot;path you specified!&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># set the class attribute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obia4rtm_home</span> <span class="o">=</span> <span class="n">obia4rtm_home</span>

        <span class="c1"># set other class attributes to None unless specified otherwise</span>

        <span class="c1"># configuration files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">landcover_cfg</span> <span class="o">=</span> <span class="kc">None</span>     <span class="c1"># landcover configuration file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prosail_cfg</span> <span class="o">=</span> <span class="kc">None</span>       <span class="c1"># prosail configuration file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">soil_refl</span> <span class="o">=</span> <span class="kc">None</span>         <span class="c1"># file with soil reflectance values</span>
        <span class="c1"># Database configuration file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend_cfg</span> <span class="o">=</span> <span class="kc">None</span>      <span class="c1"># table and schema names</span>
        <span class="c1"># tablenames</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tablenames</span> <span class="o">=</span> <span class="kc">None</span>


    <span class="c1">###########################################################################</span>
    <span class="c1">#</span>
    <span class="c1">#       Public SETTER Methods</span>
    <span class="c1">#       only necessary if the standard OBIA4RTM home directory</span>
    <span class="c1">#       (in the user profile) is NOT used</span>
    <span class="c1">#</span>
    <span class="c1">###########################################################################</span>
<div class="viewcode-block" id="API.set_landcover_cfgfile"><a class="viewcode-back" href="../../index.html#OBIA4RTM.processing_api.API.set_landcover_cfgfile">[docs]</a>    <span class="k">def</span> <span class="nf">set_landcover_cfgfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">landcover_cfg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        set landcover configuration file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        landcover_cfg : String</span>
<span class="sd">            landcover configuration file if not the default file should be used</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">landcover_cfg</span> <span class="o">=</span> <span class="n">landcover_cfg</span></div>


<div class="viewcode-block" id="API.set_prosail_cfgfile"><a class="viewcode-back" href="../../index.html#OBIA4RTM.processing_api.API.set_prosail_cfgfile">[docs]</a>    <span class="k">def</span> <span class="nf">set_prosail_cfgfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prosail_cfg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        set landcover configuration file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prosail_cfg : String</span>
<span class="sd">            prosail configuration file if not the default file should be used</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prosail_cfg</span> <span class="o">=</span> <span class="n">prosail_cfg</span></div>


<div class="viewcode-block" id="API.set_soil_refl_file"><a class="viewcode-back" href="../../index.html#OBIA4RTM.processing_api.API.set_soil_refl_file">[docs]</a>    <span class="k">def</span> <span class="nf">set_soil_refl_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">soil_refl_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        set landcover configuration file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        soil_refl_file : String</span>
<span class="sd">            file with soil reflectance values if not the default file should</span>
<span class="sd">            be used</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">soil_refl</span> <span class="o">=</span> <span class="n">soil_refl_file</span></div>


<div class="viewcode-block" id="API.set_backend_cfgfile"><a class="viewcode-back" href="../../index.html#OBIA4RTM.processing_api.API.set_backend_cfgfile">[docs]</a>    <span class="k">def</span> <span class="nf">set_backend_cfgfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backend_cfg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        set landcover configuration file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        backend_cfg : String</span>
<span class="sd">            backend configuration file if not the default file should be used</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend_cfg</span> <span class="o">=</span> <span class="n">backend_cfg</span></div>


<div class="viewcode-block" id="API.set_tablenames"><a class="viewcode-back" href="../../index.html#OBIA4RTM.processing_api.API.set_tablenames">[docs]</a>    <span class="k">def</span> <span class="nf">set_tablenames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sets the tablenames read from backend_cfg file into a list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend_cfg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backend_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obia4rtm_home</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s1">&#39;obia4rtm_backend.cfg&#39;</span>

        <span class="n">parser</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backend_cfg</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">MissingSectionHeaderError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MissingSectionHeaderError</span><span class="p">(</span><span class="s1">&#39;The obia4rtm_backend.cfg does &#39;</span>\
                         <span class="s1">&#39;not fulfil the formal requirements!&#39;</span><span class="p">,</span>
                         <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># get the schema name</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;schema-setting&#39;</span><span class="p">,</span> <span class="s1">&#39;schema_obia4rtm&#39;</span><span class="p">)</span>
        <span class="c1"># read the tablenames</span>
        <span class="n">table_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">table_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">schema</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;schema-setting&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;table_lookuptabe&#39;</span><span class="p">))</span>
        <span class="n">table_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">schema</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;schema-setting&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;table_inv_results&#39;</span><span class="p">))</span>
        <span class="n">table_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">schema</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;schema-setting&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;table_object_spectra&#39;</span><span class="p">))</span>
        <span class="n">table_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">schema</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;schema-setting&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;table_inv_mapping&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tablenames</span> <span class="o">=</span> <span class="n">table_names</span></div>


    <span class="c1">###########################################################################</span>
    <span class="c1">#</span>
    <span class="c1">#       Public GETTER Methods</span>
    <span class="c1">#</span>
    <span class="c1">###########################################################################</span>
<div class="viewcode-block" id="API.get_OBIA4RTM_home"><a class="viewcode-back" href="../../index.html#OBIA4RTM.processing_api.API.get_OBIA4RTM_home">[docs]</a>    <span class="k">def</span> <span class="nf">get_OBIA4RTM_home</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        prints the OBIA4RTM home directory</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The OBIA4RTM home is: &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obia4rtm_home</span><span class="p">))</span></div>


<div class="viewcode-block" id="API.get_use_gee"><a class="viewcode-back" href="../../index.html#OBIA4RTM.processing_api.API.get_use_gee">[docs]</a>    <span class="k">def</span> <span class="nf">get_use_gee</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        prints out if Goolge Earth Engine or Sen2Core was used for</span>
<span class="sd">        preprocessing of the satellite imagery</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__use_gee</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Google Earth Engine was used/ should be used for &#39;</span>\
                  <span class="s1">&#39;preprocessing of the imagery&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sen2Core was used/ shouldd be used for preprocessing of &#39;</span>\
                  <span class="s1">&#39;the imagery&#39;</span><span class="p">)</span></div>
        <span class="c1"># endif</span>


    <span class="c1">###########################################################################</span>
    <span class="c1">#</span>
    <span class="c1">#       Functionality wrapper Methods (private)</span>
    <span class="c1">#</span>
    <span class="c1">###########################################################################</span>
<div class="viewcode-block" id="API.do_gee_preprocessing"><a class="viewcode-back" href="../../index.html#OBIA4RTM.processing_api.API.do_gee_preprocessing">[docs]</a>    <span class="k">def</span> <span class="nf">do_gee_preprocessing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">acqui_date</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">shp_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        method to conduct the full workflow (atcorr, cloud and</span>
<span class="sd">        shadow mask, zonal stats) for imagery derived from Google Earth Engine</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        geom : List</span>
<span class="sd">            list of coordinate pairs forming a polygon that is used</span>
<span class="sd">            to determine the geograhic extent to be processed in GEE</span>
<span class="sd">        acqui_date : String</span>
<span class="sd">            acquisition date to be processed (format: YYYY-MM-DD)</span>
<span class="sd">        option : Integer</span>
<span class="sd">            option for cloud and shadow masking in preprocessing.</span>
<span class="sd">            Allowed values:     1 (ESA quality information)</span>
<span class="sd">                                2 (alternative algorithm)</span>
<span class="sd">        shp_file : String</span>
<span class="sd">            file path to the shape file with the object boundaries and the</span>
<span class="sd">            landcover / landuse information for the particular acquisition</span>
<span class="sd">            date</span>
<span class="sd">            NOTE: the shapefile must be EXACTELY in the format required</span>
<span class="sd">            by OBIA4RTM</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        scene_id : String</span>
<span class="sd">           ID of Sentinel-2 imagery</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check if GEE can be loaded</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">ee</span>
            <span class="kn">from</span> <span class="nn">ee.ee_exception</span> <span class="kn">import</span> <span class="n">EEException</span>
        <span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;To use Google-Earth-Engine the GEE Client Python API must &#39;</span>\
                  <span class="s1">&#39;be installed on your computer!&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="c1"># check if the geometry is valid</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ee</span><span class="o">.</span><span class="n">Initialize</span><span class="p">()</span>
            <span class="n">geom</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">Geometry</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">EEException</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The provided geometry is not valid!&#39;</span><span class="p">)</span>
        <span class="c1"># create an atcorr instance</span>
        <span class="n">at</span> <span class="o">=</span> <span class="n">s2_Py6S_atcorr</span><span class="p">()</span>
        <span class="c1"># run the atmospheric correction and the masking of clouds and shadows</span>
        <span class="c1"># this returns an ee.image.Image with surface reflectance values</span>
        <span class="n">S2_SRF</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">run_py6s</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">acqui_date</span><span class="p">,</span> <span class="n">option</span><span class="p">)</span>
        <span class="c1"># the retrieved surface reflectance values are then processed to extract</span>
        <span class="c1"># per object reflectance values</span>
        <span class="c1"># get the tablename of the object spectra table</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tablenames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_tablenames</span><span class="p">()</span>
        <span class="n">tablename_obj_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tablenames</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="c1"># return the metadata as this information will be lost otherwise</span>
        <span class="c1"># (but is required for the inversion)</span>
        <span class="c1"># some formatting is necessary, however</span>
        <span class="n">gee_metadata</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">info</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">parse_gee_metadata</span><span class="p">(</span><span class="n">gee_metadata</span><span class="p">)</span>
        <span class="c1"># insert the metadata into the OBIA4RTM backend</span>
        <span class="n">insert_scene_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">use_gee</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># get the scene_id and the actual acqui date as this could differ</span>
        <span class="c1"># from the one specified in case on that day no scene was found</span>
        <span class="n">scene_id</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;SCENE_ID&#39;</span><span class="p">]</span>
        <span class="n">acqui_date</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;SENSING_TIME&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span> 
        <span class="c1"># now the zonal stats function can be called</span>
        <span class="c1"># after that the preprocessing using GEE is finished</span>
        <span class="n">get_mean_refl_ee</span><span class="p">(</span><span class="n">shp_file</span><span class="p">,</span> <span class="n">S2_SRF</span><span class="p">,</span> <span class="n">acqui_date</span><span class="p">,</span> <span class="n">scene_id</span><span class="p">,</span>
                         <span class="n">tablename_obj_spec</span><span class="p">)</span>
        <span class="c1"># get the SCENE_ID and return it</span>
        <span class="k">return</span> <span class="n">scene_id</span></div>

<div class="viewcode-block" id="API.do_sen2core_preprocessing"><a class="viewcode-back" href="../../index.html#OBIA4RTM.processing_api.API.do_sen2core_preprocessing">[docs]</a>    <span class="k">def</span> <span class="nf">do_sen2core_preprocessing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sentinel_data_dir</span><span class="p">,</span>
                                   <span class="n">zipped</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">path_sen2core</span><span class="p">,</span>
                                   <span class="n">shp_file</span><span class="p">,</span> <span class="n">storage_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        calls the full preprocessing workflow using Sen2Core</span>

<span class="sd">        NOTE: Requires GDAL-Python bindings</span>
<span class="sd">        NOTE: Do not run this method on data already in L2 level!</span>
<span class="sd">            Use process_L2data instead</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sentinel_data_dir : String</span>
<span class="sd">            path to the directory that contains the Level-1C data. In case</span>
<span class="sd">            the data is zipped (default when downloaded from Copernicus) specify</span>
<span class="sd">            the file-path of the zip</span>
<span class="sd">        zipped : Boolean</span>
<span class="sd">            specifies if the directory with the Sat data is zipped</span>
<span class="sd">        resolution : Integer</span>
<span class="sd">            spatial resolution of the atmospherically corrected imagery</span>
<span class="sd">            possible value: 10, 20, 60 meters</span>
<span class="sd">        path_sen2core : String</span>
<span class="sd">            directory containing Sen2Core software (top-most level; e.g.</span>
<span class="sd">            /home/user/Sen2Core/). Must be the same directory as specified</span>
<span class="sd">            during the Sen2Core installation process using the --target option</span>
<span class="sd">        storage_dir : String</span>
<span class="sd">            path to the directory the final layer stack should be moved to. If None,</span>
<span class="sd">            the layer stack will remain the sentinel_data_dir_l2 in the img folder</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        scene_id:</span>
<span class="sd">            ID of the processed Sentinel-2 scene</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check if input is almost L2 level -&gt; in this case this function</span>
        <span class="c1"># is not suited, use process_L2data instead</span>
        <span class="k">if</span> <span class="n">sentinel_data_dir</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;MSIL2A&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Warning</span><span class="p">(</span><span class="s1">&#39;Seems as if your Sentinel data is already in Level 2A!</span><span class="se">\n</span><span class="s1">&#39;</span>\
                          <span class="s1">&#39;Please use the function process_L2data from the &#39;</span>\
                          <span class="s1">&#39;processing API instead.&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="c1"># call sen2core Python wrapper and prepare the output for usage in</span>
        <span class="c1"># OBIA4RTM</span>
        <span class="c1"># returns file name of Sentinel-2 imagery in L2 level and the</span>
        <span class="c1"># file path to the metadata xml</span>
        <span class="n">fname_s2</span><span class="p">,</span> <span class="n">metadata_xml</span> <span class="o">=</span> <span class="n">do_sen2core_preprocessing</span><span class="p">(</span><span class="n">sentinel_data_dir</span><span class="p">,</span>
                                                           <span class="n">zipped</span><span class="p">,</span>
                                                           <span class="n">resolution</span><span class="p">,</span>
                                                           <span class="n">path_sen2core</span><span class="p">,</span>
                                                           <span class="n">storage_dir</span><span class="o">=</span><span class="n">storage_dir</span><span class="p">)</span>
        <span class="c1"># get the tablename of the object spectra table</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tablenames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_tablenames</span><span class="p">()</span>
        <span class="n">tablename_obj_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tablenames</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="c1"># parse the metadata and insert it into the database</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">parse_s2xml</span><span class="p">(</span><span class="n">metadata_xml</span><span class="p">)</span>
        <span class="n">insert_scene_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">use_gee</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">raster</span><span class="o">=</span><span class="n">fname_s2</span><span class="p">)</span>
        <span class="c1"># get the scene_id and the acquisition date</span>
        <span class="n">scene_id</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;SCENE_ID&#39;</span><span class="p">]</span>
        <span class="n">acqui_date</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;SENSING_TIME&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>
        <span class="c1"># with that information, the zonal statistics can be computed</span>
        <span class="c1"># using the provided shapefile with the object boundaries and</span>
        <span class="c1"># the landuser/ cover information</span>
        <span class="n">get_mean_refl</span><span class="p">(</span><span class="n">shp_file</span><span class="p">,</span> <span class="n">fname_s2</span><span class="p">,</span> <span class="n">acqui_date</span><span class="p">,</span> <span class="n">scene_id</span><span class="p">,</span>
                      <span class="n">tablename_obj_spec</span><span class="p">)</span>
        <span class="c1"># return the SCENE_ID</span>
        <span class="k">return</span> <span class="n">scene_id</span></div>


<div class="viewcode-block" id="API.process_L2data"><a class="viewcode-back" href="../../index.html#OBIA4RTM.processing_api.API.process_L2data">[docs]</a>    <span class="k">def</span> <span class="nf">process_L2data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sentinel_data_dir</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span>
                       <span class="n">shp_file</span><span class="p">,</span> <span class="n">acqui_date</span><span class="p">,</span> <span class="n">storage_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        formats the output of data already acquired in ESA L2 format</span>
<span class="sd">        in the format required by OBIA4RTM and runs the zonal stats procedure</span>
<span class="sd">        to get per object reflectance values</span>

<span class="sd">        NOTE: Requires GDAL-Python bindings</span>
<span class="sd">        NOTE: Do not run this method on data already in L2 level!</span>
<span class="sd">            Use get_mean_refl instead</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sentinel_data_dir : String</span>
<span class="sd">            path to the directory that contains the Level-1C data. In case</span>
<span class="sd">            the data is zipped (default when downloaded from Copernicus) specify</span>
<span class="sd">            the file-path of the zip</span>
<span class="sd">        resolution : Integer</span>
<span class="sd">            spatial resolution of the atmospherically corrected imagery</span>
<span class="sd">            possible value: 10, 20, 60 meters</span>
<span class="sd">        storage_dir : String</span>
<span class="sd">            path to the directory the final layer stack should be moved to. If None,</span>
<span class="sd">            the layer stack will remain the sentinel_data_dir_l2 in the img folder</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        scene_id:</span>
<span class="sd">            ID of the processed Sentinel-2 scene</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># returns file name of Sentinel-2 imagery in L2 level and the</span>
        <span class="c1"># file path to the metadata xml</span>
        <span class="n">fname_s2</span><span class="p">,</span> <span class="n">metadata_xml</span> <span class="o">=</span> <span class="n">call_gdal_merge</span><span class="p">(</span><span class="n">sentinel_data_dir</span><span class="p">,</span>
                                              <span class="n">resolution</span><span class="p">,</span>
                                              <span class="n">storage_dir</span><span class="o">=</span><span class="n">storage_dir</span><span class="p">)</span>
        <span class="c1"># with that information, the zonal statistics can be computed</span>
        <span class="c1"># using the provided shapefile with the object boundaries and</span>
        <span class="c1"># the landuser/ cover information</span>
        <span class="c1"># get the tablename of the object spectra table</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tablenames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_tablenames</span><span class="p">()</span>
        <span class="n">tablename_obj_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tablenames</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># parse the metadata and insert it into the database</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">parse_s2xml</span><span class="p">(</span><span class="n">metadata_xml</span><span class="p">)</span>
        <span class="n">insert_scene_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">use_gee</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">raster</span><span class="o">=</span><span class="n">fname_s2</span><span class="p">)</span>
        <span class="c1"># get the scene_id and the acquisition date</span>
        <span class="n">scene_id</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;SCENE_ID&#39;</span><span class="p">]</span>
        <span class="n">acqui_date</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;SENSING_TIME&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>
        <span class="n">get_mean_refl</span><span class="p">(</span><span class="n">shp_file</span><span class="p">,</span> <span class="n">fname_s2</span><span class="p">,</span> <span class="n">acqui_date</span><span class="p">,</span> <span class="n">scene_id</span><span class="p">,</span>
                      <span class="n">tablename_obj_spec</span><span class="p">)</span>
        <span class="c1"># return the SCENE_ID</span>
        <span class="k">return</span> <span class="n">scene_id</span></div>


<div class="viewcode-block" id="API.do_inversion"><a class="viewcode-back" href="../../index.html#OBIA4RTM.processing_api.API.do_inversion">[docs]</a>    <span class="k">def</span> <span class="nf">do_inversion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scene_id</span><span class="p">,</span> <span class="n">num_best_solutions</span><span class="p">,</span> <span class="n">luc_classes</span><span class="p">,</span>
                     <span class="n">return_specs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        this method performs the actual inversion part of OBIA4RTM by taking</span>
<span class="sd">        the derived Sentinel-2 spectra on a per-object base and building a</span>
<span class="sd">        corresponding lookup-table out of ProSAIL forward runs that is then</span>
<span class="sd">        used to do the inversion by applying a RMSE cost function. To enhance</span>
<span class="sd">        the stability of the inversion process, a user-defined number of &quot;best</span>
<span class="sd">        solutions&quot; can be used for the parameter mapping e.g. the mean of the</span>
<span class="sd">        20 best matching inversion results in terms of the lowest RMSE between</span>
<span class="sd">        observed and simulated Sentinel-2 spectra. The results of the inversion</span>
<span class="sd">        process are stored in the OBIA4RTM database.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scene_id : String</span>
<span class="sd">           ID of Sentinel-2 imagery. This is the foreign key to match the</span>
<span class="sd">           satellite spectra with the according LUT built from ProSAIL forward</span>
<span class="sd">           runs</span>
<span class="sd">        num_best_solutions : Integer</span>
<span class="sd">            number of &quot;best solutions&quot; of the inversion process in terms of</span>
<span class="sd">            lowest RMSE values between observed and simulated Sentinel-2 spectra</span>
<span class="sd">            Must be in the range between 1 and &lt; number of spectra in the LUT</span>
<span class="sd">        luc_classes : List</span>
<span class="sd">            list of land use or land cover codes to be inverted. The integer</span>
<span class="sd">            codes must be exactly the same as in the ProSail parameterization and</span>
<span class="sd">            the parcel classification.</span>
<span class="sd">        return_specs : Boolean</span>
<span class="sd">            specifies whether inverted spectra should be written to the DB</span>
<span class="sd">            (Default: True) or not. Storing the inverted spectra might help</span>
<span class="sd">            to better understand and evaluate the quality of the performed</span>
<span class="sd">            inversion and might help to further improve the parametrization</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        status : Integer:</span>
<span class="sd">            status code; zero if everything was working out; -1 instead</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># create an inversion class instance using the provided scene id</span>
        <span class="c1"># first, check if the provided scene-id is valid as well as the provided</span>
        <span class="c1"># number of best solutions</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">scene_id</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span>           <span class="c1"># scene id must not be an empty string</span>
            <span class="k">assert</span> <span class="n">num_best_solutions</span> <span class="o">&gt;</span> <span class="mi">0</span>   <span class="c1"># number of solutions must be at least 1</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">luc_classes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>     <span class="c1"># number of classes must be at least 1</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">inverter</span> <span class="o">=</span> <span class="n">inversion</span><span class="p">(</span><span class="n">scene_id</span><span class="p">)</span>
        <span class="c1"># if not already done yet, set tablenames for storing the results</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tablenames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_tablenames</span><span class="p">()</span>
        <span class="c1"># determine the tables for the inversion</span>
        <span class="n">inv_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tablenames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># lookup-table for ProSAIL runs</span>
        <span class="n">res_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tablenames</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># table the results will be written to</span>
        <span class="n">obj_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tablenames</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># table with the obj spectra</span>
        <span class="n">inv_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tablenames</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>    <span class="c1"># mapping of the results</span>
        <span class="c1"># construct the lookup table first using the user-provided</span>
        <span class="c1"># parameterizations</span>
        <span class="n">inverter</span><span class="o">.</span><span class="n">gen_lut</span><span class="p">(</span><span class="n">inv_map</span><span class="p">,</span> <span class="n">inv_table</span><span class="p">)</span>
        <span class="c1"># now the inversion method can be called for each of the luc classes</span>
        <span class="k">for</span> <span class="n">luc</span> <span class="ow">in</span> <span class="n">luc_classes</span><span class="p">:</span>
            <span class="n">luc_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">luc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">inverter</span><span class="o">.</span><span class="n">do_inversion</span><span class="p">(</span><span class="n">luc_int</span><span class="p">,</span>
                                  <span class="n">num_best_solutions</span><span class="p">,</span>
                                  <span class="n">res_table</span><span class="p">,</span>
                                  <span class="n">obj_table</span><span class="p">,</span>
                                  <span class="n">inv_map</span><span class="p">,</span>
                                  <span class="n">inv_table</span><span class="p">,</span>
                                  <span class="n">return_specs</span><span class="o">=</span><span class="n">return_specs</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Lukas Graf.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.0.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>